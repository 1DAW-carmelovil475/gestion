<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Tickets | Hola Informática</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#0047b3">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="./css/gestion_usuarios.css">
    <link rel="stylesheet" href="./css/tickets.css">
</head>
<body>

<!-- TOPBAR -->
<header class="topbar">
    <div class="logo">
        <img src="./img/logoHola.png" alt="Logo Hola Informática">
        <span class="logo-text">Hola Informática</span>
    </div>
    <nav class="top-nav">
        <a href="./gestion_usuarios.html" class="nav-link"><i class="fas fa-building"></i> Empresas</a>
        <a href="./gestion_usuarios.html#usuarios" class="nav-link" data-admin-only><i class="fas fa-users-cog"></i> Usuarios</a>
        <a href="./tickets.html" class="nav-link active"><i class="fas fa-headset"></i> Tickets</a>
        <a href="./estadisticas.html" class="nav-link" data-admin-only><i class="fas fa-chart-bar"></i> Estadísticas</a>
        <a href="./chat.html" class="nav-link"><i class="fas fa-comments"></i> Chat</a>
    </nav>
    <div class="user-area">
        <div class="user-info">
            <i class="fas fa-user-circle"></i>
            <span id="usuarioNombre" class="user-name-text">Cargando...</span>
        </div>
        <button id="logoutBtn" class="btn-logout">
            <i class="fas fa-sign-out-alt"></i>
            <span class="logout-text">Salir</span>
        </button>
    </div>
</header>

<!-- BOTTOM NAV MOBILE -->
<nav class="bottom-nav">
    <a class="bottom-nav-item" href="./gestion_usuarios.html"><i class="fas fa-building"></i><span>Empresas</span></a>
    <a class="bottom-nav-item" href="./gestion_usuarios.html#usuarios" data-admin-only><i class="fas fa-users-cog"></i><span>Usuarios</span></a>
    <a class="bottom-nav-item active"><i class="fas fa-headset"></i><span>Tickets</span></a>
    <a class="bottom-nav-item" href="./estadisticas.html" data-admin-only><i class="fas fa-chart-bar"></i><span>Stats</span></a>
    <a class="bottom-nav-item" href="./chat.html"><i class="fas fa-comments"></i><span>Chat</span></a>
</nav>

<!-- MAIN: VISTA LISTA -->
<main class="main-content" id="vistaLista">
    <div class="section-header">
        <div>
            <h1><i class="fas fa-headset"></i> Tickets</h1>
            <p>Gestión de incidencias y soporte</p>
        </div>
        <div class="header-actions">
            <button class="btn-primary" onclick="abrirModalNuevoTicket()">
                <i class="fas fa-plus"></i>
                <span class="btn-label">Nuevo Ticket</span>
            </button>
        </div>
    </div>

    <!-- STATS -->
    <div class="stats" id="statsBar">
        <div class="stat-card stat-clickable" onclick="setFiltroEstado('all')">
            <div class="stat-icon" style="background:#dbeafe;color:#2563eb"><i class="fas fa-ticket-alt"></i></div>
            <div class="stat-info"><h3 id="statTotal">0</h3><p>Total</p></div>
        </div>
        <div class="stat-card stat-clickable" onclick="setFiltroEstado('Pendiente')">
            <div class="stat-icon" style="background:#fef3c7;color:#d97706"><i class="fas fa-clock"></i></div>
            <div class="stat-info"><h3 id="statPendientes">0</h3><p>Pendientes</p></div>
        </div>
        <div class="stat-card stat-clickable" onclick="setFiltroEstado('En curso')">
            <div class="stat-icon" style="background:#dbeafe;color:#2563eb"><i class="fas fa-spinner"></i></div>
            <div class="stat-info"><h3 id="statEnCurso">0</h3><p>En curso</p></div>
        </div>
        <div class="stat-card stat-clickable" onclick="setFiltroEstado('Completado')">
            <div class="stat-icon" style="background:#dcfce7;color:#16a34a"><i class="fas fa-check-circle"></i></div>
            <div class="stat-info"><h3 id="statCompletados">0</h3><p>Completados</p></div>
        </div>
        <div class="stat-card stat-clickable" onclick="setFiltroEstado('Facturado')">
            <div class="stat-icon" style="background:#f3e8ff;color:#9333ea"><i class="fas fa-file-invoice-dollar"></i></div>
            <div class="stat-info"><h3 id="statFacturados">0</h3><p>Facturados</p></div>
        </div>
        <div class="stat-card stat-clickable" onclick="setFiltroPrioridad('Urgente')">
            <div class="stat-icon" style="background:#fee2e2;color:#dc2626"><i class="fas fa-exclamation-circle"></i></div>
            <div class="stat-info"><h3 id="statUrgentes">0</h3><p>Urgentes</p></div>
        </div>
    </div>

    <!-- FILTROS -->
    <div class="tickets-filters">
        <div class="filter-row-main">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchTicket" placeholder="Buscar por asunto, empresa, #número...">
            </div>
            <div class="filter-chips">
                <select id="filtroEstado" onchange="cargarTickets()">
                    <option value="all">Todos los estados</option>
                    <option value="abiertos">Abiertos (Pendiente + En curso)</option>
                    <option value="Pendiente">Pendiente</option>
                    <option value="En curso">En curso</option>
                    <option value="Completado">Completado</option>
                    <option value="Facturado">Facturado</option>
                </select>
                <select id="filtroPrioridad" onchange="cargarTickets()">
                    <option value="all">Prioridad</option>
                    <option value="Urgente">Urgente</option>
                    <option value="Alta">Alta</option>
                    <option value="Media">Media</option>
                    <option value="Baja">Baja</option>
                </select>
                <select id="filtroOperario" onchange="cargarTickets()">
                    <option value="all">Operario</option>
                </select>
                <select id="filtroEmpresa" onchange="cargarTickets()">
                    <option value="all">Empresa</option>
                </select>
            </div>
        </div>
        <div class="filter-row-secondary">
            <div class="date-range">
                <i class="fas fa-calendar"></i>
                <input type="date" id="filtroDesde" onchange="cargarTickets()">
                <span>—</span>
                <input type="date" id="filtroHasta" onchange="cargarTickets()">
                <button class="btn-clear-dates" onclick="limpiarFechas()" title="Limpiar fechas">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <span id="totalFiltrado" class="total-badge">0 tickets</span>
        </div>
    </div>

    <!-- TABLA DESKTOP -->
    <div class="table-container desktop-only">
        <table>
            <thead>
                <tr>
                    <th style="width:60px">#</th>
                    <th>Empresa</th>
                    <th>Asunto</th>
                    <th>Operarios</th>
                    <th>Prioridad</th>
                    <th>Estado</th>
                    <th>Tiempo abierto</th>
                    <th>Creado</th>
                    <th style="width:80px">Acciones</th>
                </tr>
            </thead>
            <tbody id="ticketsTableBody">
                <tr><td colspan="9" class="empty-state"><i class="fas fa-spinner fa-spin"></i> Cargando...</td></tr>
            </tbody>
        </table>
    </div>

    <!-- CARDS MOBILE -->
    <div class="cards-list mobile-only" id="ticketsCardsList"></div>
</main>

<!-- ============================================================
     VISTA DETALLE TICKET
     ============================================================ -->
<div id="vistaDetalle" class="vista-detalle" style="display:none">

    <!-- Header -->
    <div class="detalle-topbar">
        <button class="btn-back" onclick="volverALista()">
            <i class="fas fa-arrow-left"></i>
            <span>Tickets</span>
        </button>
        <div class="detalle-titulo">
            <span class="ticket-numero-badge" id="detalleNumero">#1</span>
            <h2 id="detalleAsunto">Cargando...</h2>
        </div>
        <div class="detalle-acciones-top">
            <select id="detalleEstadoSelect" class="estado-select-inline" onchange="cambiarEstado(this.value)">
                <option value="Pendiente">Pendiente</option>
                <option value="En curso">En curso</option>
                <option value="Completado">Completado</option>
                <option value="Facturado">Facturado</option>
            </select>
            <button class="btn-action btn-edit" onclick="abrirModalEditarTicket()" title="Editar">
                <i class="fas fa-edit"></i> <span>Editar</span>
            </button>
            <button class="btn-action btn-delete" id="btnEliminarTicket" onclick="eliminarTicket()" title="Eliminar">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    </div>

    <!-- Cuerpo: sidebar + área principal (notas + comentarios) -->
    <div class="detalle-body">

        <!-- COLUMNA IZQUIERDA: info + operarios + archivos + historial -->
        <aside class="detalle-sidebar">

            <div class="sidebar-card">
                <div class="sidebar-card-title"><i class="fas fa-info-circle"></i> Información</div>
                <div class="info-rows" id="detalleInfoRows"></div>
            </div>

            <div class="sidebar-card">
                <div class="sidebar-card-title">
                    <span><i class="fas fa-users"></i> Operarios</span>
                    <button class="btn-mini" onclick="abrirModalAsignar()"><i class="fas fa-plus"></i></button>
                </div>
                <div id="detalleOperarios" class="operarios-list"></div>
            </div>

            <div class="sidebar-card">
                <div class="sidebar-card-title">
                    <span><i class="fas fa-paperclip"></i> Archivos del ticket</span>
                    <button class="btn-mini" onclick="triggerUploadArchivo()"><i class="fas fa-upload"></i></button>
                </div>
                <input type="file" id="archivoInput" multiple style="display:none" onchange="subirArchivos()">
                <div id="detalleArchivos" class="archivos-list"></div>
            </div>

            <div class="sidebar-card sidebar-card-historial">
                <div class="sidebar-card-title" onclick="toggleHistorial()" style="cursor:pointer">
                    <span><i class="fas fa-history"></i> Historial</span>
                    <i class="fas fa-chevron-down" id="historialChevron"></i>
                </div>
                <div id="detalleHistorial" class="historial-list" style="display:none"></div>
            </div>

        </aside>

        <!-- COLUMNA DERECHA: NOTAS + COMENTARIOS (tabs) -->
        <div class="detalle-main-area">

            <!-- TABS -->
            <div class="detalle-tabs">
                <button class="detalle-tab active" onclick="switchTab('notas', this)">
                    <i class="fas fa-sticky-note"></i> Notas privadas
                </button>
                <button class="detalle-tab" onclick="switchTab('comentarios', this)">
                    <i class="fas fa-comments"></i> Comentarios
                    <span class="tab-badge" id="comentariosBadge" style="display:none">0</span>
                </button>
            </div>

            <!-- PANEL: NOTAS -->
            <div id="panelNotas" class="tab-panel active">
                <div class="notas-header">
                    <div style="display:flex;align-items:center;gap:8px">
                        <i class="fas fa-sticky-note" style="color:var(--primary)"></i>
                        <span style="font-weight:600;font-size:0.88rem;color:var(--dark)">Notas privadas del ticket</span>
                    </div>
                    <span id="notasIndicador" style="font-size:0.78rem;color:var(--gray);font-style:italic"></span>
                </div>
                <textarea
                    id="detalleNotas"
                    class="notas-textarea"
                    placeholder="Notas privadas — solo visibles para el equipo. Se guardan automáticamente."
                    oninput="onNotasChange()"
                ></textarea>
            </div>

            <!-- PANEL: COMENTARIOS -->
            <div id="panelComentarios" class="tab-panel" style="display:none">
                <!-- Lista de comentarios -->
                <div id="comentariosLista" class="comentarios-lista">
                    <div class="comentarios-loading">
                        <i class="fas fa-spinner fa-spin"></i> Cargando comentarios...
                    </div>
                </div>

                <!-- Formulario nuevo comentario -->
                <div class="comentario-nuevo">
                    <div class="comentario-nuevo-header">
                        <div id="comentarioAutorAvatar" class="avatar-sm"></div>
                        <span id="comentarioAutorNombre" style="font-size:0.82rem;font-weight:600;color:var(--dark)"></span>
                    </div>
                    <textarea
                        id="nuevoComentarioTexto"
                        class="comentario-textarea"
                        placeholder="Escribe un comentario... (Shift+Enter para salto de línea, Enter para enviar)"
                        rows="3"
                        onkeydown="handleComentarioKeydown(event)"
                    ></textarea>

                    <!-- Archivos adjuntos preview -->
                    <div id="comentarioArchivosPreview" class="archivos-preview" style="display:none"></div>

                    <div class="comentario-actions-bar">
                        <div class="comentario-attach-area">
                            <button class="btn-attach" onclick="triggerComentarioArchivo()" title="Adjuntar archivo">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <span id="comentarioArchivosCount" style="font-size:0.78rem;color:var(--gray)"></span>
                        </div>
                        <button class="btn-primary btn-sm" onclick="enviarComentario()">
                            <i class="fas fa-paper-plane"></i> Comentar
                        </button>
                    </div>
                    <input type="file" id="comentarioArchivoInput" multiple style="display:none" onchange="onComentarioArchivosSeleccionados()">
                </div>
            </div>

        </div><!-- fin detalle-main-area -->
    </div>

</div>

<!-- ============================================================
     MODALES
     ============================================================ -->

<!-- MODAL: Nuevo / Editar Ticket -->
<div class="modal" id="ticketModal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2 id="ticketModalTitle"><i class="fas fa-ticket-alt"></i> Nuevo Ticket</h2>
            <button class="modal-close" onclick="cerrarModalTicket()"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="editTicketId">
            <div class="form-row">
                <div class="form-group">
                    <label>Empresa *</label>
                    <select id="ticketEmpresa" required onchange="cargarDispositivosEmpresa()">
                        <option value="">Seleccionar empresa...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Equipo / Dispositivo</label>
                    <select id="ticketDispositivo">
                        <option value="">Sin dispositivo</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Asunto *</label>
                <input type="text" id="ticketAsunto" placeholder="Describe brevemente el problema..." required>
            </div>
            <div class="form-group">
                <label>Descripción detallada</label>
                <textarea id="ticketDescripcion" rows="4" placeholder="Pasos para reproducir, contexto, errores..."></textarea>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Prioridad</label>
                    <select id="ticketPrioridad">
                        <option value="Baja">Baja</option>
                        <option value="Media" selected>Media</option>
                        <option value="Alta">Alta</option>
                        <option value="Urgente">Urgente</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Estado inicial</label>
                    <select id="ticketEstado">
                        <option value="Pendiente">Pendiente</option>
                        <option value="En curso">En curso</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Asignar operarios</label>
                <div id="operariosCheckboxes" class="operarios-checkboxes"></div>
            </div>
        </div>
        <div class="modal-buttons">
            <button class="btn-primary" onclick="guardarTicket()"><i class="fas fa-save"></i> Guardar</button>
            <button class="btn-secondary" onclick="cerrarModalTicket()">Cancelar</button>
        </div>
    </div>
</div>

<!-- MODAL: Asignar operarios -->
<div class="modal" id="asignarModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-users"></i> Asignar operarios</h2>
            <button class="modal-close" onclick="cerrarModalAsignar()"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <div id="asignarOperariosLista" class="operarios-checkboxes"></div>
        </div>
        <div class="modal-buttons">
            <button class="btn-primary" onclick="guardarAsignaciones()"><i class="fas fa-save"></i> Guardar</button>
            <button class="btn-secondary" onclick="cerrarModalAsignar()">Cancelar</button>
        </div>
    </div>
</div>

<!-- TOAST -->
<div class="toast-container" id="toastContainer"></div>

<script src="./js/config.js"></script>
<script src="./js/tickets.js"></script>
<script>
    document.getElementById('logoutBtn').addEventListener('click', function() {
        if (confirm('¿Cerrar sesión?')) {
            sessionStorage.clear();
            window.location.href = './index.html';
        }
    });
</script>
</body>
</html>